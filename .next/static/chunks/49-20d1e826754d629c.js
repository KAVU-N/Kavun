"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[49],{2406:function(e,t,r){r.r(t),r.d(t,{AuthProvider:function(){return a},useAuth:function(){return l}});var n=r(3827),o=r(4090),s=r(7907);let i=(0,o.createContext)({user:null,loading:!1,error:null,login:async()=>{},register:async()=>{},logout:async()=>{},setUser:()=>{}});function a(e){let{children:t}=e,[r,a]=(0,o.useState)(null),[l,c]=(0,o.useState)(!0),[d,u]=(0,o.useState)(null),[m,h]=(0,o.useState)(!1),x=(0,s.useRouter)();(0,o.useEffect)(()=>{h(!0);try{let e=localStorage.getItem("user");if(e){let t=JSON.parse(e);a(t)}}catch(e){console.error("Error loading user from localStorage:",e)}finally{c(!1)}},[]);let g=async e=>{c(!0),u(null);try{let t=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(403===t.status&&r.needsVerification){u("L\xfctfen \xf6nce email adresinizi doğrulayın"),x.push("/auth/verify?email=".concat(encodeURIComponent(r.email)));return}if(!t.ok)throw Error(r.error||"Giriş yapılırken bir hata oluştu");a(r.user),localStorage.setItem("user",JSON.stringify(r.user)),localStorage.setItem("token",r.token),"student"===r.user.role?x.push("/egitmenler"):x.push("/")}catch(e){throw u(e.message),e}finally{c(!1)}},f=async e=>{c(!0),u(null);try{let t=await fetch("/api/auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw Error(r.error||"Kayıt olurken bir hata oluştu");let n=null;r.user?(n=r.user,console.log("API yanıtı result.user i\xe7inde bulundu:",n)):r.id||r._id||r.name||r.email?(n=r,console.log("API yanıtı doğrudan result i\xe7inde bulundu:",n)):(console.log("API yanıtında kullanıcı verisi bulunamadı, ge\xe7ici kullanıcı oluşturuluyor"),n={id:Math.random().toString(36).substring(2,15),name:e.name,email:e.email,role:e.role,university:e.university,isVerified:!1}),console.log("Kullanıcının kayıt formunda se\xe7tiği rol:",e.role),console.log("API yanıtında gelen rol (varsa):",n.role);let o={id:n.id||n._id||"",name:n.name||e.name||"",email:n.email||e.email||"",role:e.role||n.role||"student",university:n.university||e.university||"",isVerified:n.isVerified||!1,expertise:n.expertise};console.log("Doğrulanmış kullanıcı verisi:",o),x.push("/auth/verify?email=".concat(encodeURIComponent(o.email)))}catch(e){throw console.error("Kayıt hatası:",e),u(e.message),e}finally{c(!1)}},p=async()=>{c(!0),u(null);try{let e=await fetch("/api/auth/logout",{method:"POST"});if(!e.ok){let t=await e.json();throw Error(t.error||"\xc7ıkış yapılırken bir hata oluştu")}a(null),localStorage.removeItem("user"),localStorage.removeItem("token"),x.push("/auth/login")}catch(e){throw u(e.message),e}finally{c(!1)}};return m?(0,n.jsx)(i.Provider,{value:{user:r,loading:l,error:d,login:g,register:f,logout:p,setUser:a},children:t}):(0,n.jsx)(i.Provider,{value:{user:null,loading:!0,error:null,login:async()=>{},register:async()=>{},logout:async()=>{},setUser:()=>{}},children:t})}function l(){return(0,o.useContext)(i)}},8049:function(e,t,r){var n=r(3827),o=r(4090),s=r(703),i=r(6782),a=r(2406),l=r(9079);t.Z=e=>{let{instructor:t,onClose:r,containerStyles:c,embedded:d=!1}=e,{user:u}=(0,a.useAuth)(),[m,h]=(0,o.useState)([]),[x,g]=(0,o.useState)(""),[f,p]=(0,o.useState)(!1),[y,v]=(0,o.useState)(!0),[w,b]=(0,o.useState)(!1),j=(0,o.useRef)(null),k=(0,o.useRef)(null),N=(0,o.useRef)(null),S=(0,o.useRef)(null),[F,_]=(0,o.useState)(400),C=(0,o.useRef)(void 0),[E,A]=(0,o.useState)(!1);(0,o.useEffect)(()=>{t._id&&u&&P()},[t._id,u]),(0,o.useEffect)(()=>{if(u)try{console.log("Socket.io bağlantısı kuruluyor...");let e=(0,i.ZP)(l.env.NEXT_PUBLIC_SOCKET_URL||"http://localhost:5000",{transports:["polling","websocket"],reconnectionAttempts:5,reconnectionDelay:1e3,timeout:2e4,forceNew:!0,autoConnect:!0});return j.current=e,e.on("connect",()=>{console.log("Socket.io bağlantısı kuruldu, ID:",e.id),(null==u?void 0:u.id)&&(e.emit("join",u.id),console.log("Kullanıcı odasına katıldı:",u.id))}),e.on("connect_error",e=>{console.error("Socket.io bağlantı hatası:",e)}),e.on("connect_timeout",()=>{console.error("Socket.io bağlantı zaman aşımı")}),e.on("reconnect",e=>{console.log("Socket.io yeniden bağlandı, deneme: ".concat(e))}),e.on("reconnect_error",e=>{console.error("Socket.io yeniden bağlanma hatası:",e)}),e.on("reconnect_failed",()=>{console.error("Socket.io yeniden bağlanma başarısız")}),e.on("receive-message",e=>{if(console.log("Yeni mesaj alındı:",e),e.sender===t._id&&e.receiver===(null==u?void 0:u.id)||e.sender===(null==u?void 0:u.id)&&e.receiver===t._id){let t={sender:e.sender,receiver:e.receiver,content:e.content,createdAt:new Date,read:!1,isMine:e.sender===(null==u?void 0:u.id)};h(e=>[...e,t])}}),e.on("user-typing",e=>{e.sender===t._id&&(p(!0),C.current&&clearTimeout(C.current),C.current=setTimeout(()=>{p(!1)},3e3))}),()=>{j.current&&(console.log("Socket.io bağlantısı kapatılıyor..."),j.current.disconnect())}}catch(e){console.error("Socket.io bağlantısı kurulurken hata:",e)}},[t._id,u]),(0,o.useEffect)(()=>{N.current&&_(N.current.scrollHeight)},[m]);let P=async()=>{if(t._id&&u){v(!0);try{let e=localStorage.getItem("token");if(!e){console.error("Token bulunamadı");return}let r=await fetch("/api/messages?receiverId=".concat(t._id),{headers:{Authorization:"Bearer ".concat(e)}});if(!r.ok)throw Error("Mesajlar y\xfcklenirken bir hata oluştu: ".concat(r.status));let n=await r.json();if(console.log("API yanıtı:",n),n&&Array.isArray(n.messages)){let e=n.messages.map(e=>({...e,isMine:e.sender===(null==u?void 0:u.id)}));h(e)}else if(n&&Array.isArray(n)){let e=n.map(e=>({...e,isMine:e.sender===(null==u?void 0:u.id)}));h(e)}else console.error("Beklenmeyen API yanıt formatı:",n),h([]);setTimeout(M,300)}catch(e){console.error("Mesajlar y\xfcklenirken hata oluştu:",e)}finally{v(!1)}}},I=async e=>{if(e.preventDefault(),e.stopPropagation(),x.trim()&&u)try{let e=localStorage.getItem("token");if(!e){console.error("Token bulunamadı");return}let r={sender:u.id,receiver:t._id,content:x.trim(),createdAt:new Date,read:!1,isMine:!0};h(e=>[...e,r]),g(""),setTimeout(M,100),j.current&&j.current.emit("send-message",{sender:u.id,receiver:t._id,content:x.trim()});let n=await fetch("/api/messages",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({receiver:t._id,content:x.trim()})});n.ok||console.error("Mesaj g\xf6nderilirken bir hata oluştu:",n.status)}catch(e){console.error("Mesaj g\xf6nderilirken hata oluştu:",e)}},M=()=>{S.current&&(S.current.scrollTop=S.current.scrollHeight)},B={position:d?"relative":"fixed",right:d?void 0:"20px",bottom:d?void 0:"20px",height:d?"100%":"350px",maxHeight:d?"100%":"350px",width:d?"100%":"384px",zIndex:40,display:"flex",flexDirection:"column",borderRadius:d?"0.5rem":"0.75rem",overflow:"hidden",boxShadow:d?"none":"0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",transition:"all 0.3s ease",...c};return(0,n.jsxs)("div",{ref:N,style:{...B,display:"flex",flexDirection:"column",height:d?"calc(100vh - 200px)":E?"50px":"300px",maxHeight:d?"calc(100vh - 200px)":E?"50px":"300px",transition:"height 0.3s ease, max-height 0.3s ease"},className:"bg-white",children:[(0,n.jsxs)("div",{className:"bg-gradient-to-r from-[#FFB996] to-[#FF8B5E] p-2 flex items-center justify-between cursor-pointer",style:{flexShrink:0},onClick:()=>!d&&A(!E),children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsxs)("div",{className:"w-8 h-8 rounded-full bg-white flex items-center justify-center mr-3 relative",children:[(0,n.jsx)("span",{className:"text-[#FF8B5E] font-bold",children:t.name.charAt(0)}),Array.isArray(m)&&m.filter(e=>!e.read&&e.sender===t._id).length>0&&(0,n.jsx)("div",{className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-xs text-white font-bold",children:m.filter(e=>!e.read&&e.sender===t._id).length})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-white font-medium text-sm",children:t.name}),(0,n.jsx)("p",{className:"text-white/70 text-xs",children:t.university})]})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[!E&&r&&(0,n.jsx)("button",{onClick:e=>{e.stopPropagation(),r()},className:"text-white hover:text-white/80",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),!d&&(0,n.jsx)("div",{className:"ml-2 text-white",children:E?(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})}):(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})]})]}),(d||!E)&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{ref:S,className:"overflow-y-auto p-4 bg-[#FFFBF8]",style:{flexGrow:1,height:"calc(100% - 90px)"},onClick:e=>e.stopPropagation(),children:y?(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-[#FF8B5E]"})}):0===m.length?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center text-gray-500",children:[(0,n.jsx)(s.default,{src:"/images/chat-empty.svg",alt:"No messages",width:100,height:100,className:"mb-4 opacity-50"}),(0,n.jsx)("p",{className:"text-sm",children:"Hen\xfcz mesaj yok. Sohbeti başlatmak i\xe7in bir mesaj g\xf6nder!"})]}):(0,n.jsxs)(n.Fragment,{children:[m.map((e,t)=>{let r=0===t||m[t-1].sender!==e.sender,o=t===m.length-1||m[t+1].sender!==e.sender;return(0,n.jsx)("div",{className:"flex ".concat(e.isMine?"justify-end":"justify-start"," mb-2"),children:(0,n.jsxs)("div",{className:"max-w-[75%] rounded-lg px-2 py-1 ".concat(e.isMine?"bg-gradient-to-r from-[#FFB996] to-[#FF8B5E] text-white rounded-tr-none":"bg-white border border-[#FFE5D9] text-gray-800 rounded-tl-none"," ").concat(r?"mt-2":"mt-1"," ").concat(o?"mb-2":"mb-1"),children:[(0,n.jsx)("div",{className:"text-sm",children:e.content}),(0,n.jsxs)("div",{className:"flex justify-end ".concat(e.isMine?"text-white/70":"text-gray-500"),style:{fontSize:"0.5rem",lineHeight:"0.7rem",marginTop:"3px"},children:[new Date(e.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e.isMine&&(0,n.jsx)("span",{className:"ml-1",children:"✓"})]})]})},e._id||t)}),f&&(0,n.jsxs)("div",{className:"flex items-center text-gray-500 text-sm mt-2",children:[(0,n.jsxs)("div",{className:"flex space-x-1 mr-2",children:[(0,n.jsx)("div",{className:"w-2 h-2 rounded-full bg-gray-400 animate-bounce",style:{animationDelay:"0ms"}}),(0,n.jsx)("div",{className:"w-2 h-2 rounded-full bg-gray-400 animate-bounce",style:{animationDelay:"150ms"}}),(0,n.jsx)("div",{className:"w-2 h-2 rounded-full bg-gray-400 animate-bounce",style:{animationDelay:"300ms"}})]}),(0,n.jsxs)("span",{children:[t.name," yazıyor..."]})]}),(0,n.jsx)("div",{ref:k})]})}),(0,n.jsx)("div",{className:"bg-white border-t border-[#FFE5D9] p-3",style:{flexShrink:0,minHeight:"70px",position:"relative",bottom:0,left:0,right:0,zIndex:10,width:"100%"},onClick:e=>e.stopPropagation(),children:(0,n.jsx)("form",{onSubmit:I,className:"w-full h-full",children:(0,n.jsxs)("div",{className:"flex items-center w-full h-full space-x-2",children:[(0,n.jsx)("input",{type:"text",value:x,onChange:e=>g(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),e.stopPropagation(),I(e))},placeholder:"Mesajınızı yazın...",className:"flex-1 border border-[#FFE5D9] rounded-xl py-2 px-4 focus:outline-none focus:border-[#FF8B5E] transition-colors duration-300",autoComplete:"off",onClick:e=>e.stopPropagation()}),(0,n.jsx)("button",{type:"submit",disabled:!x.trim(),className:"bg-gradient-to-r from-[#FFB996] to-[#FF8B5E] text-white p-2 rounded-xl disabled:opacity-50 flex items-center justify-center w-[42px] h-[42px] hover:shadow-md transition-all duration-300","aria-label":"Mesaj g\xf6nder",children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})})})]})]})}}}]);