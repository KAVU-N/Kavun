"use strict";(()=>{var e={};e.id=7217,e.ids=[7217],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},12781:e=>{e.exports=require("stream")},73837:e=>{e.exports=require("util")},13828:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>w,originalPathname:()=>Z,patchFetch:()=>M,requestAsyncStorage:()=>h,routeModule:()=>v,serverHooks:()=>j,staticGenerationAsyncStorage:()=>b,staticGenerationBailout:()=>x});var a={};t.r(a),t.d(a,{GET:()=>k,POST:()=>f});var n=t(95419),o=t(69108),s=t(99678),i=t(78070),l=t(22345),u=t(41773),c=t(52055),d=t(7348),m=t(7439),g=t(46082),p=t.n(g);async function y(e){let r=(0,m.headers)().get("Authorization"),t=r?.replace("Bearer ","");if(!t)return console.error("Token bulunamadı"),null;try{console.log("Token doğrulanıyor...");let e=process.env.JWT_SECRET||"default_secret";console.log("JWT Secret kullanılıyor (ilk 5 karakter):",e.substring(0,5)+"...");let r=p().verify(t,e);return console.log("Token başarıyla doğrulandı:",{email:r.email,name:r.name,id:r.userId||r.id||r._id}),{...r,id:r.userId||r.id||r._id}}catch(e){return console.error("Token doğrulama hatası:",e),null}}async function k(e){console.log("GET /api/messages isteği alındı");try{let{searchParams:r}=new URL(e.url),t=r.get("receiverId");if(console.log("Alınan parametreler:",{receiverId:t}),!t)return console.error("receiverId parametresi eksik"),i.Z.json({error:"receiverId parametresi gerekli"},{status:400});let a=await y(e);if(!a)return console.error("Ge\xe7ersiz veya eksik token"),i.Z.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});if(console.log("GET Messages - User info from token:",a),!a.id)return console.error("Token i\xe7inde kullanıcı ID bilgisi yok"),i.Z.json({error:"Kullanıcı kimliği bulunamadı"},{status:400});try{console.log("MongoDB bağlantısı kuruluyor..."),await (0,l.Z)(),console.log("MongoDB bağlantısı başarılı")}catch(e){return console.error("MongoDB bağlantı hatası:",e),i.Z.json({error:"Veritabanı bağlantı hatası"},{status:500})}console.log(`Kullanıcı ID: ${a.id} ve alıcı ID: ${t} arasındaki mesajlar aranıyor...`);let n=await u.Z.find({$or:[{sender:a.id,receiver:t},{sender:t,receiver:a.id}]}).sort({createdAt:1});console.log("Bulunan mesaj sayısı:",n.length);let o=await c.Z.findById(t,"name email profilePicture");if(!o)return console.error("Karşı kullanıcı bulunamadı:",t),i.Z.json({error:"Karşı kullanıcı bulunamadı"},{status:404});console.log("Karşı kullanıcı bulundu:",o.name),await u.Z.updateMany({sender:t,receiver:a.id,read:!1},{read:!0});let s=n.map(e=>({_id:e._id,sender:e.sender,receiver:e.receiver,content:e.content,createdAt:e.createdAt,read:e.read,isMine:e.sender.toString()===a.id}));return i.Z.json({messages:s,user:o})}catch(e){return console.error("Mesajlar getirilemedi:",e),i.Z.json({error:`Mesajlar getirilemedi: ${e.message||"Bilinmeyen hata"}`},{status:500})}}async function f(e){console.log("POST /api/messages isteği alındı");try{let r;let t=await y(e);if(!t)return console.error("Ge\xe7ersiz veya eksik token"),i.Z.json({error:"Oturum a\xe7manız gerekiyor"},{status:401});if(console.log("POST Message - User info from token:",t),!t.id)return console.error("Token i\xe7inde kullanıcı ID bilgisi yok"),i.Z.json({error:"Kullanıcı kimliği bulunamadı"},{status:400});try{console.log("MongoDB bağlantısı kuruluyor..."),await (0,l.Z)(),console.log("MongoDB bağlantısı başarılı")}catch(e){return console.error("MongoDB bağlantı hatası:",e),i.Z.json({error:"Veritabanı bağlantı hatası"},{status:500})}try{r=await e.json(),console.log("İstek verisi:",{...r,content:r.content?.substring(0,20)+"..."})}catch(e){return console.error("İstek verisi \xe7\xf6z\xfcmlemede hata:",e),i.Z.json({error:"İstek verisi \xe7\xf6z\xfcmlenemedi"},{status:400})}if(!r.receiver||!r.content)return console.error("Eksik alanlar:",{receiver:!!r.receiver,content:!!r.content}),i.Z.json({error:"receiver ve content alanları zorunludur"},{status:400});if(!await c.Z.findById(r.receiver))return console.error("Alıcı kullanıcı bulunamadı:",r.receiver),i.Z.json({error:"Alıcı kullanıcı bulunamadı"},{status:404});let a=await u.Z.create({sender:t.id,receiver:r.receiver,content:r.content,read:!1});console.log("Yeni mesaj oluşturuldu:",a._id);let n=await d.Z.findOne({participants:{$all:[t.id,r.receiver],$size:2}});n?(n.lastMessage=r.content,n.updatedAt=new Date,await n.save()):(console.log("Yeni konuşma oluşturuluyor..."),n=await d.Z.create({participants:[t.id,r.receiver],lastMessage:r.content})),console.log("Konuşma g\xfcncellendi:",n._id);let o={_id:a._id,sender:a.sender,receiver:a.receiver,content:a.content,createdAt:a.createdAt,read:a.read,isMine:!0};return i.Z.json(o,{status:201})}catch(e){return console.error("Mesaj g\xf6nderilemedi:",e),i.Z.json({error:`Mesaj g\xf6nderilemedi: ${e.message||"Bilinmeyen hata"}`},{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/messages/route",pathname:"/api/messages",filename:"route",bundlePath:"app/api/messages/route"},resolvedPagePath:"C:\\Users\\eren\\Kavun, organization\\app\\api\\messages\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:b,serverHooks:j,headerHooks:w,staticGenerationBailout:x}=v,Z="/api/messages/route";function M(){return(0,s.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:b})}},22345:(e,r,t)=>{t.d(r,{Z:()=>i});var a=t(11185),n=t.n(a);let o=process.env.MONGODB_URI;if(!o)throw Error("MongoDB URI bulunamadı. L\xfctfen .env dosyasını kontrol edin.");let s=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=s);let i=async function(){if(s.conn)return s.conn;s.promise||(s.promise=n().connect(o,{bufferCommands:!1}).then(e=>e));try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},7348:(e,r,t)=>{t.d(r,{Z:()=>s});var a=t(11185),n=t.n(a);let o=new a.Schema({participants:[{type:a.Schema.Types.ObjectId,ref:"User"}],lastMessage:{type:String,default:""},updatedAt:{type:Date,default:Date.now},createdAt:{type:Date,default:Date.now}});o.index({participants:1},{unique:!1});let s=n().models.Conversation||n().model("Conversation",o)},41773:(e,r,t)=>{t.d(r,{Z:()=>s});var a=t(11185),n=t.n(a);let o=new a.Schema({sender:{type:a.Schema.Types.ObjectId,ref:"User",required:[!0,"G\xf6nderen alanı zorunludur"]},receiver:{type:a.Schema.Types.ObjectId,ref:"User",required:[!0,"Alıcı alanı zorunludur"]},content:{type:String,required:[!0,"Mesaj i\xe7eriği zorunludur"],trim:!0,maxlength:[500,"Mesaj en fazla 500 karakter olabilir"]},read:{type:Boolean,default:!1},createdAt:{type:Date,default:Date.now}}),s=n().models.Message||n().model("Message",o)},52055:(e,r,t)=>{t.d(r,{Z:()=>s});var a=t(11185),n=t.n(a);let o=new a.Schema({name:{type:String,required:[!0,"Ad alanı zorunludur"],trim:!0,minlength:[2,"Ad en az 2 karakter olmalıdır"],maxlength:[50,"Ad en fazla 50 karakter olabilir"]},email:{type:String,required:[!0,"Email alanı zorunludur"],unique:!0,trim:!0,lowercase:!0,validate:{validator:function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)},message:"Ge\xe7erli bir email adresi giriniz"}},password:{type:String,required:[!0,"Şifre alanı zorunludur"],minlength:[8,"Şifre en az 8 karakter olmalıdır"],select:!1},role:{type:String,required:[!0,"Rol alanı zorunludur"],enum:{values:["student","teacher"],message:"Ge\xe7erli bir rol se\xe7iniz"}},university:{type:String,required:[!0,"\xdcniversite alanı zorunludur"],trim:!0},isVerified:{type:Boolean,default:!1},verificationCode:String,verificationCodeExpires:Date,resetPasswordCode:String,resetPasswordExpires:Date,expertise:{type:String,default:"",trim:!0},createdAt:{type:Date,default:Date.now}},{timestamps:!0,strict:!0,strictQuery:!0,collection:"users"});o.index({email:1},{unique:!0});try{n().deleteModel("User")}catch(e){}let s=n().model("User",o)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[1638,6206,6082,7439],()=>t(13828));module.exports=a})();